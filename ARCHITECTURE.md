# manga-platform: Архитектура

## Дата создания
03 Ноября 2025

## Общее описание

Type-first модульная платформа для каталогизации манги, манхвы, манхуа с игровыми механиками.
Текущее состояние: модульный монолит на Next.js с готовностью к миграции на микросервисы.

## Ключевые принципы

1. **Type-first подход** - типы определяют архитектуру
2. **Zero-any политика** - полный запрет на использование any в TypeScript
3. **exactOptionalPropertyTypes** - строгое соблюдение опциональных свойств
4. **Модульность** - четкое разделение ответственности между модулями
5. **Event-driven** - асинхронное взаимодействие между модулями
6. **Независимость модулей** - каждый модуль может работать автономно

## Слои архитектуры

### API Layer (Next.js Routes)
- Единая точка входа для всех клиентских запросов
- Валидация через Zod
- Маршрутизация в модули
- Унифицированные ответы и обработка ошибок

### Services Layer
- Бизнес-логика модулей
- Правила и инварианты
- Транзакционные операции
- Оркестрация процессов

### Repositories Layer
- Интерфейсы доступа к данным
- Реализации для PostgreSQL/Supabase
- Кеширование через Redis
- Внешние API адаптеры

### Events Layer
- Доменные события
- Event Bus (In-Memory → Redis в будущем)
- Асинхронные обработчики
- Event sourcing для критических операций

### Types Layer
- Доменные типы в packages/types
- API контракты
- Event контракты
- Database адаптеры

## Модули системы

### Модуль Users
**Ответственность:**
- Аутентификация и авторизация
- Управление профилями
- Пользовательские настройки
- Email верификация
- Роли и права доступа

### Модуль Catalog
**Ответственность:**
- CRUD операции над произведениями
- Управление жанрами и тегами
- Поиск и фильтрация
- Связи между сущностями
- Метаданные произведений

### Модуль Reading Tracker
**Ответственность:**
- Отслеживание прогресса чтения
- Управление закладками
- История чтения
- Пользовательские оценки и рецензии
- Персональные коллекции

### Модуль Content Parser
**Ответственность:**
- Плагинная система парсинга сайтов
- Административная панель конфигурации
- Планировщик задач парсинга
- Нормализация данных
- Антиспам механизмы

### Модуль Extension Bridge
**Ответственность:**
- API для браузерных расширений
- API для мобильных приложений
- Прием активности чтения
- Валидация и нормализация событий
- Rate limiting и безопасность

### Модуль Game Engine
**Ответственность:**
- Единые игровые правила
- Расчет и выдача наград (coins/gems/exp/cards)
- Система уровней и опыта
- Управление игровым инвентарем
- Триггеры достижений
- Антиабуз и лимиты

### Модуль Cards & Inventory
**Ответственность:**
- Определение карточек и их метаданных
- Управление наборами карточек (паками)
- Вероятности выпадения
- Хранение пользовательского инвентаря
- Операции с карточками (только через Game Engine)

### Модуль Achievements
**Ответственность:**
- Определения достижений
- Отслеживание прогресса
- Условия разблокировки
- Система наград
- Обработка игровых событий

### Модуль Trading & Marketplace
**Ответственность:**
- P2P торговля между пользователями
- Маркетплейс карточек
- Аукционная система
- Комиссии и экономические модели
- Антифрод механизмы

### Модуль Notifications
**Ответственность:**
- Email уведомления
- Push уведомления (Web/Mobile)
- In-app уведомления
- Пользовательские предпочтения
- Rate limiting и доставка

### Модуль Analytics
**Ответственность:**
- Сбор событий пользователей
- Отчеты по чтению и активности
- Экономические метрики
- Ретеншн аналитика
- A/B тестирование

## Событийная модель

### Ключевые события

```typescript
// Активность чтения
interface ReadingActivityEvent {
  type: 'reading.activity';
  userId: string;
  workId: string;
  chapterNumber: number;
  timeSpent: number;
  completionPercentage: number;
  source: 'web' | 'extension' | 'mobile';
}

// Обнаружение контента
interface WorkDiscoveredEvent {
  type: 'work.discovered';
  workData: WorkMetadata;
  source: string;
  parserId: string;
}

// Выдача награды
interface RewardIssuedEvent {
  type: 'engine.reward.issued';
  userId: string;
  rewardType: 'coins' | 'gems' | 'exp' | 'card';
  amount?: number;
  cardId?: string;
  reason: string;
}

// Разблокировка достижения
interface AchievementUnlockedEvent {
  type: 'achievement.unlocked';
  userId: string;
  achievementId: string;
  rewards: Reward[];
}
```

### Правила событий
- Все события версионируются (v1, v2, etc.)
- Обработчики идемпотентны
- Повторная доставка не нарушает инварианты
- Best-effort обработка - ошибки не ломают основной поток

## База данных

### Архитектура данных
- **Основная БД**: PostgreSQL через Supabase
- **Кеш**: Redis для сессий и часто используемых данных
- **Файлы**: Supabase Storage для аватаров и изображений карточек
- **Аналитика**: PostgreSQL на старте, ClickHouse при росте

### Схема данных
Детальная схема описана в отдельном документе DATABASE_SCHEMA.md

Основные таблицы:
- `users` - пользователи
- `works` - произведения
- `user_bookmarks` - закладки
- `user_balances` - игровые балансы
- `cards` - карточки
- `user_cards` - инвентарь пользователей
- `achievements` - достижения
- `trades` - торговые сделки
- `notifications` - уведомления

## Независимость модулей

### Принципы
- **Слабая связанность**: модули взаимодействуют только через события
- **Graceful degradation**: отказ одного модуля не ломает другие
- **Feature flags**: возможность отключения модулей без редеплоя
- **Контрактные интерфейсы**: четкие API между модулями

### Стратегии интеграции
- Заглушки (mocks) для неготовых модулей
- Условное выполнение функций через feature flags
- Асинхронная обработка через события
- Fallback механизмы при недоступности зависимостей

## Инфраструктура

### Текущий стек (MVP)
- **Frontend**: Next.js 14 + TypeScript + Tailwind CSS
- **Backend**: Next.js API Routes
- **База данных**: Supabase (PostgreSQL)
- **Аутентификация**: Supabase Auth + JWT
- **Файлы**: Supabase Storage
- **Хостинг**: Vercel
- **Домен**: .ru или VPS с возможностью оплаты из России

### При росте нагрузки
- **VPS**: Docker Compose на Timeweb/Reg.ru
- **База данных**: PostgreSQL + Redis
- **Файлы**: MinIO self-hosted
- **Мониторинг**: Grafana + Prometheus
- **Логи**: Loki или ELK Stack

## Порядок разработки

### Фаза 1: MVP платформы (2-3 недели)
1. **Users** - аутентификация, профили, роли
2. **Catalog** - произведения, поиск, фильтры
3. **Reading Tracker** - закладки, прогресс чтения

**Результат**: Работающая платформа для отслеживания чтения

### Фаза 2: Источники данных (3-4 недели)
4. **Content Parser** - парсинг внешних сайтов
5. **Extension Bridge** - API для расширений

**Результат**: Автоматическое пополнение каталога и трекинг активности

### Фаза 3: Игровые механики (4-5 недель)
6. **Game Engine** - правила наград, валюта, уровни
7. **Cards & Inventory** - карточная система
8. **Achievements** - система достижений

**Результат**: Полноценная игрификация платформы

### Фаза 4: Социальные функции (3-4 недели)
9. **Trading & Marketplace** - торговля карточками
10. **Notifications** - система уведомлений
11. **Analytics** - метрики и аналитика

**Результат**: Завершенная платформа со всеми функциями

## Безопасность

### Аутентификация и авторизация
- JWT токены с коротким временем жизни
- Email верификация обязательна
- Rate limiting на критичные операции
- RBAC система ролей

### Защита данных
- Валидация всех пользовательских данных
- Sanitization контента
- XSS и CSRF защита
- Логирование критичных операций

### Игровая экономика
- Антиабуз механизмы
- Лимиты на заработок валюты
- Детекция подозрительной активности
- Аудит всех экономических операций

## Мониторинг и наблюдаемость

### Healthchecks
- Модульные проверки здоровья
- Статус страница
- Автоматические алерты

### Метрики
- Производительность API
- Использование ресурсов
- Игровые метрики
- Пользовательская активность

### Логирование
- Структурированные логи
- Корреляционные ID
- Уровни логирования по модулям
- Централизованная агрегация

## Миграция к микросервисам

### Готовность архитектуры
Текущая модульная структура позволяет легко выделить модули в отдельные сервисы:
- Четкие границы модулей
- Event-driven коммуникация
- Независимые базы данных
- Контрактные API

### План миграции
1. **Content Parser** → первый кандидат (тяжелые операции)
2. **Analytics** → отдельная база данных ClickHouse
3. **Game Engine** → высоконагруженные вычисления
4. **Остальные модули** → по мере необходимости

### Инфраструктура микросервисов
- Kubernetes оркестрация
- Service mesh (Istio)
- API Gateway
- Distributed tracing
- Centralized logging

---

**Примечание**: Данная архитектура спроектирована для поэтапного развития от простого MVP до полнофункциональной платформы с возможностью масштабирования до микросервисной архитектуры при росте нагрузки.